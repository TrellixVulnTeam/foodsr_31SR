{"ast":null,"code":"/*\n* Copyright 2013 ZXing authors\n*\n* Licensed under the Apache License, Version 2.0 (the \"License\");\n* you may not use this file except in compliance with the License.\n* You may obtain a copy of the License at\n*\n*      http://www.apache.org/licenses/LICENSE-2.0\n*\n* Unless required by applicable law or agreed to in writing, software\n* distributed under the License is distributed on an \"AS IS\" BASIS,\n* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n* See the License for the specific language governing permissions and\n* limitations under the License.\n*/\n// package com.google.zxing.pdf417.decoder;\n// import com.google.zxing.common.detector.MathUtils;\nimport MathUtils from '../../common/detector/MathUtils'; // import com.google.zxing.pdf417.PDF417Common;\n\nimport PDF417Common from '../PDF417Common';\nimport Float from '../../util/Float';\n/**\n * @author Guenther Grau\n * @author creatale GmbH (christoph.schulz@creatale.de)\n */\n\nvar PDF417CodewordDecoder = function () {\n  function PDF417CodewordDecoder() {}\n  /* @note\n   * this action have to be performed before first use of class\n   * - static constructor\n   * working with 32bit float (based from Java logic)\n  */\n\n\n  PDF417CodewordDecoder.initialize = function () {\n    // Pre-computes the symbol ratio table.\n    for (\n    /*int*/\n    var i = 0; i < PDF417Common.SYMBOL_TABLE.length; i++) {\n      var currentSymbol = PDF417Common.SYMBOL_TABLE[i];\n      var currentBit = currentSymbol & 0x1;\n\n      for (\n      /*int*/\n      var j = 0; j < PDF417Common.BARS_IN_MODULE; j++) {\n        var size = 0.0;\n\n        while ((currentSymbol & 0x1) === currentBit) {\n          size += 1.0;\n          currentSymbol >>= 1;\n        }\n\n        currentBit = currentSymbol & 0x1;\n\n        if (!PDF417CodewordDecoder.RATIOS_TABLE[i]) {\n          PDF417CodewordDecoder.RATIOS_TABLE[i] = new Array(PDF417Common.BARS_IN_MODULE);\n        }\n\n        PDF417CodewordDecoder.RATIOS_TABLE[i][PDF417Common.BARS_IN_MODULE - j - 1] = Math.fround(size / PDF417Common.MODULES_IN_CODEWORD);\n      }\n    }\n\n    this.bSymbolTableReady = true;\n  };\n\n  PDF417CodewordDecoder.getDecodedValue = function (moduleBitCount) {\n    var decodedValue = PDF417CodewordDecoder.getDecodedCodewordValue(PDF417CodewordDecoder.sampleBitCounts(moduleBitCount));\n\n    if (decodedValue !== -1) {\n      return decodedValue;\n    }\n\n    return PDF417CodewordDecoder.getClosestDecodedValue(moduleBitCount);\n  };\n\n  PDF417CodewordDecoder.sampleBitCounts = function (moduleBitCount) {\n    var bitCountSum = MathUtils.sum(moduleBitCount);\n    var result = new Int32Array(PDF417Common.BARS_IN_MODULE);\n    var bitCountIndex = 0;\n    var sumPreviousBits = 0;\n\n    for (\n    /*int*/\n    var i = 0; i < PDF417Common.MODULES_IN_CODEWORD; i++) {\n      var sampleIndex = bitCountSum / (2 * PDF417Common.MODULES_IN_CODEWORD) + i * bitCountSum / PDF417Common.MODULES_IN_CODEWORD;\n\n      if (sumPreviousBits + moduleBitCount[bitCountIndex] <= sampleIndex) {\n        sumPreviousBits += moduleBitCount[bitCountIndex];\n        bitCountIndex++;\n      }\n\n      result[bitCountIndex]++;\n    }\n\n    return result;\n  };\n\n  PDF417CodewordDecoder.getDecodedCodewordValue = function (moduleBitCount) {\n    var decodedValue = PDF417CodewordDecoder.getBitValue(moduleBitCount);\n    return PDF417Common.getCodeword(decodedValue) === -1 ? -1 : decodedValue;\n  };\n\n  PDF417CodewordDecoder.getBitValue = function (moduleBitCount) {\n    var result =\n    /*long*/\n    0;\n\n    for (var\n    /*int*/\n    i = 0; i < moduleBitCount.length; i++) {\n      for (\n      /*int*/\n      var bit = 0; bit < moduleBitCount[i]; bit++) {\n        result = result << 1 | (i % 2 === 0 ? 1 : 0);\n      }\n    }\n\n    return Math.trunc(result);\n  }; // working with 32bit float (as in Java)\n\n\n  PDF417CodewordDecoder.getClosestDecodedValue = function (moduleBitCount) {\n    var bitCountSum = MathUtils.sum(moduleBitCount);\n    var bitCountRatios = new Array(PDF417Common.BARS_IN_MODULE);\n\n    if (bitCountSum > 1) {\n      for (var\n      /*int*/\n      i = 0; i < bitCountRatios.length; i++) {\n        bitCountRatios[i] = Math.fround(moduleBitCount[i] / bitCountSum);\n      }\n    }\n\n    var bestMatchError = Float.MAX_VALUE;\n    var bestMatch = -1;\n\n    if (!this.bSymbolTableReady) {\n      PDF417CodewordDecoder.initialize();\n    }\n\n    for (\n    /*int*/\n    var j = 0; j < PDF417CodewordDecoder.RATIOS_TABLE.length; j++) {\n      var error = 0.0;\n      var ratioTableRow = PDF417CodewordDecoder.RATIOS_TABLE[j];\n\n      for (\n      /*int*/\n      var k = 0; k < PDF417Common.BARS_IN_MODULE; k++) {\n        var diff = Math.fround(ratioTableRow[k] - bitCountRatios[k]);\n        error += Math.fround(diff * diff);\n\n        if (error >= bestMatchError) {\n          break;\n        }\n      }\n\n      if (error < bestMatchError) {\n        bestMatchError = error;\n        bestMatch = PDF417Common.SYMBOL_TABLE[j];\n      }\n    }\n\n    return bestMatch;\n  }; // flag that the table is ready for use\n\n\n  PDF417CodewordDecoder.bSymbolTableReady = false;\n  PDF417CodewordDecoder.RATIOS_TABLE = new Array(PDF417Common.SYMBOL_TABLE.length).map(function (x) {\n    return x = new Array(PDF417Common.BARS_IN_MODULE);\n  });\n  return PDF417CodewordDecoder;\n}();\n\nexport default PDF417CodewordDecoder; //# sourceMappingURL=PDF417CodewordDecoder.js.map","map":null,"metadata":{},"sourceType":"module"}